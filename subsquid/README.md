# Subsquid SDK Example

Here's an example of how SDK packages can be combined into a working indexer (called squid) on Neon EVM Devnet.
This squid example tracks transfers of WNEON on Neon EVM Devnet, then save the resulting data to PostgreSQL and serve it as a GraphQL API.

## Prerequisites

1. NodeJS 16.x or newer
2. Docker

## Cloning repository

Run command

```sh
git clone https://github.com/neonlabsorg/neon-tutorials.git
```

**NOTE** All the next operations must be performed from the **neon-tutorials/subsquid** directory.

## Install the required dependencies

```sh
cd neon-tutorials/subsquid
npm install
```

**NOTE** Before starting, make a copy of .env.local.example file and rename it to .env
<br><br><br>

### Steps to run the squid to get data for WNEON contract

1. Start the database container -

```sh
docker compose up -d
```

2. Apply the already configured migration with -

```sh
npx squid-typeorm-migration apply
```

3. Compile the project and start the processor process -

```sh
npx tsc
node -r dotenv/config lib/main.js
```

4. In a separate terminal, configure the GraphQL port and start the GraphQL server -

```sh
npx squid-graphql-server
```

The finished GraphQL API with GraphiQL will be available at localhost:4350/graphql.
<br><br><br>

### Steps to run a squid on your own for any other contract data

1. Change the properties in the "schema.graphql" according to the contract you want to get the data from.

2. Delete the already existing folders - "lib", "db" and "src/model", "src/abi". These will be auto-generated by the commands in the later steps.

3. Generate TypeORM classes based on the schema -

```sh
npx squid-typeorm-codegen
```

The TypeORM classes are now available at src/model/index.ts.

4. Start the database container -

```sh
docker compose up -d
```

5. Compile the TypeORM classes -

```sh
npx tsc
```

6. Generate the migration file -

```sh
npx squid-typeorm-migration generate
```

7. Apply the migration with -

```sh
npx squid-typeorm-migration apply
```

8. Create a file with ".json" extension under src/abi (for example - src/abi/example.json) and copy the contracts's ABI into it.

9. Run -

```sh
npx squid-evm-typegen src/abi ./src/abi/example.json
```

The utility classes will be now available at src/abi/example.ts.

10. Change the code in src/main.ts according to your contract data and database schema.

11. Compile the project and start the processor process -

```sh
npx tsc
node -r dotenv/config lib/main.js
```

12. In a separate terminal, configure the GraphQL port and start the GraphQL server -

```sh
npx squid-graphql-server
```

The finished GraphQL API with GraphiQL will be available at localhost:4350/graphql.

> [!IMPORTANT]  
> To run a squid on Neon EVM Mainnet, there needs to be some changes to some of the above mentioned steps.

1. Replace `RPC_NEON_HTTP=https://devnet.neonevm.org` to `RPC_NEON_HTTP=https://neon-proxy-mainnet.solana.p2p.org` in the `.env`.
2. Change the following in the `src/main.ts` file:

- `setGateway("https://v2.archive.subsquid.io/network/neon-mainnet")`
- `setBlockRange({ from: 195350522 })` (Neon EVM Mainnet genesis block)
